import $ from"./node_modules/next/dist/server/next.js";import R from"./node_modules/express/index.js";import{MongoClient as C}from"./node_modules/mongodb/lib/index.js";import{ObjectId as D}from"./node_modules/bson/lib/bson.js";import P from"./node_modules/formidable/src/index.js";import{createReadStream as _,createWriteStream as T,existsSync as I,mkdirSync as j}from"fs";import{createHash as H}from"crypto";import{getToken as E}from"./node_modules/next-auth/jwt/index.js";function N(n){let t=new TextEncoder().encode(n),e=H("sha256").update(t).digest();return Array.from(new Uint8Array(e)).map(a=>a.toString(16).padStart(2,"0")).join("")}var b=parseInt(`${process.env.PORT}`)||3e3,O=process.env.NODE_ENV!=="production",S=$({dev:O}),A=S.getRequestHandler(),w=O?"devProcurement":"Procurement",h="FilesMetadata";async function y(){return await new C(process.env.EXPRESS_MONGO_STRING+"").connect()}function B(n){return"originalFilename"in n}function L(n){return"length"in n}async function W(n){return await(await y()).db(w).collection(h).findOne({_id:n},{projection:{filename:1,dir:1}})}async function z(n){let t=await y(),e=await t.db(w).collection(h).insertOne(n).then(s=>s.insertedId);return await t.close(),e}async function G(n,t){let e=await y(),s=await e.db(w).collection(h).updateOne({_id:n},{$set:{dir:t.dir}}).then(l=>l.upsertedId);return await e.close(),s}function v(n=""){let t=n.split("; "),e={};return t.forEach(s=>{let l=s.indexOf("="),a=s.substring(0,l),o=s.substring(l+1);e[a]=decodeURIComponent(o)}),e}process.env.FILE_DIR||console.log("Environment FILE_DIR is not defined. Default directory will be used.");var g=process.env.FILE_DIR||process.cwd()+"/files";S.prepare().then(()=>{let n=R();n.get("/files/:fmid",async(t,e,s)=>{if(t.cookies=v(t.headers.cookie),!await E({req:t,secret:`${process.env.JWT_SECRET}`}))return e.status(401).end();try{let a=await W(new D(t.params.fmid));if(a){let{filename:o,dir:i}=a;if(!i||i&&!I(i))return e.status(404).end("Can't find that file, sorry!");console.log(`File downloading: ${o}
At: ${i}`),e.download(`${i}`,`${o}`,function(r){return r?(console.log(`Error downloading: ${r}`),s(r)):(console.log(`Successfully downloaded: ${o}`),e.status(200).end())})}else return e.status(404).end("Can't find that file, sorry!")}catch(a){return console.log(a),e.status(500).end("Something went wrong.")}}).post("/files/",async(t,e)=>{if(t.cookies=v(t.headers.cookie),!await E({req:t,secret:`${process.env.JWT_SECRET}`}))return e.status(401).end();let l=P(),a=new Promise((o,i)=>{l.parse(t,(r,c,d)=>{r&&i(r),o({fields:c,files:d})})});I(g)||j(g,{recursive:!0}),await a.then(o=>{let{files:i}=o,r=[];if(B(i.file)?r[0]=i.file:L(i.file)&&(r=i.file),r.length<1)throw new Error("Can't find any files");r.forEach(async c=>{let d=c.originalFilename?.lastIndexOf("."),F=c.originalFilename?.substring(d?d+1:0),f=await z({filename:c.originalFilename?c.originalFilename:"",filetype:F||"",contentType:c.mimetype?c.mimetype:"",size:c.size,uploadDate:new Date}),u=g+"/"+N(f.toHexString())+".file";return await new Promise((m,k)=>{let x=_(c.filepath),p=T(u);p.on("error",M=>{k(M)}),p.on("finish",()=>{m()}),x.pipe(p)}).catch(m=>{throw new Error(m)}),await G(f,{dir:u}),console.log(`New file uploaded at: ${u}`),console.log("fmid: "+f.toHexString()),e.status(201).json({data:{fmid:f.toHexString()}})})}).catch(o=>(console.log(o),e.status(500).end(o)))}).all("*",(t,e)=>A(t,e)),n.listen(b,()=>{console.log(`Server started on port ${b}`)})}).catch(n=>{console.error(n),process.exit(1)});

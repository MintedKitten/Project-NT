"use strict";var B=Object.create;var M=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var q=(e,n,t,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of z(n))!k.call(e,o)&&o!==t&&M(e,o,{get:()=>n[o],enumerable:!(r=T(n,o))||r.enumerable});return e};var u=(e,n,t)=>(t=e!=null?B(G(e)):{},q(n||!e||!e.__esModule?M(t,"default",{value:e,enumerable:!0}):t,e));var v=u(require("./node_modules/dotenv/lib/main.js"),1),P=u(require("./node_modules/next/dist/server/next.js"),1),$=u(require("./node_modules/express/index.js"),1),E=require("./node_modules/mongodb/lib/index.js"),j=require("./node_modules/bson/lib/bson.js"),C=u(require("./node_modules/formidable/src/index.js"),1),s=require("fs"),H=require("crypto");v.config({path:"/.env.local"});function U(e){let n=new TextEncoder().encode(e),t=(0,H.createHash)("sha256").update(n).digest();return Array.from(new Uint8Array(t)).map(l=>l.toString(16).padStart(2,"0")).join("")}var b=parseInt(`${process.env.PORT}`,10)||3e3,A=process.env.NODE_ENV!=="production",D=(0,P.default)({dev:A}),V=D.getRequestHandler(),F=A?"devProcurement":"Procurement",I="FilesMetadata",w;async function O(){return w||(w=new E.MongoClient(process.env.EXPRESS_MONGO_STRING+"")),await w.connect()}function W(e){return"originalFilename"in e}function X(e){return"length"in e}async function J(e){return await(await O()).db(F).collection(I).findOne({_id:e},{projection:{filename:1,dir:1}})}async function K(e){let n=await O(),t=await n.db(F).collection(I).insertOne(e).then(r=>r.insertedId);return await n.close(),t}async function L(e,n){let t=await O(),r=await t.db(F).collection(I).updateOne({_id:e},{$set:{dir:n.dir}}).then(o=>o.upsertedId);return await t.close(),r}var y="./files/";D.prepare().then(()=>{let e=(0,$.default)();e.get("/files/:fmid",async(n,t,r)=>{try{let o=await J(new j.ObjectId(n.params.fmid));if(o){let{filename:l,dir:i}=o;if(!i||i&&!(0,s.existsSync)(i))return t.status(404).end("Can't find that file, sorry!");console.log(`File downloading: ${l}
At: ${i}`),t.download(`${i}`,`${l}`,function(d){return d?(console.log(`Error downloading: ${d}`),r(d)):(console.log(`Successfully downloaded: ${l}`),t.status(200).end())})}else return t.status(404).end("Can't find that file, sorry!")}catch(o){return console.log(o),t.status(500).end("Something went wrong.")}}).post("/files/",async(n,t,r)=>{let o=(0,C.default)(),l=new Promise((i,d)=>{o.parse(n,(c,f,a)=>{c&&d(c),i({fields:f,files:a})})});(0,s.existsSync)(y)||(0,s.mkdirSync)(y),await l.then(i=>{let{fields:d,files:c}=i,f=[];if(W(c.file)?f[0]=c.file:X(c.file)&&(f=c.file),f.length<1)throw new Error("Can't find any files");f.forEach(async a=>{let S=a.originalFilename?.lastIndexOf("."),x=a.originalFilename?.substring(S?S+1:0),m=await K({filename:a.originalFilename?a.originalFilename:"",filetype:x||"",contentType:a.mimetype?a.mimetype:"",size:a.size,uploadDate:new Date}),p=y+U(m.toHexString());return await new Promise((g,N)=>{let R=(0,s.createReadStream)(a.filepath),h=(0,s.createWriteStream)(p);h.on("error",_=>{N(_)}),h.on("finish",()=>{g()}),R.pipe(h)}).catch(g=>{throw new Error(g)}),await L(m,{dir:p}),console.log(`New file uploaded at: ${p}`),console.log("fmid: "+m.toHexString()),t.status(201).json({data:{fmid:m.toHexString()}})})}).catch(i=>(console.log(i),t.status(500).end(i)))}).all("*",(n,t)=>V(n,t)),e.listen(b,()=>{console.log(`Server started on port ${b}`)})}).catch(e=>{console.error(e),process.exit(1)});

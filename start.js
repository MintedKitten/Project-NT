"use strict";var T=Object.create;var S=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var L=(e,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of _(t))!z.call(e,o)&&o!==n&&S(e,o,{get:()=>t[o],enumerable:!(a=V(t,o))||a.enumerable});return e};var u=(e,t,n)=>(n=e!=null?T(k(e)):{},L(t||!e||!e.__esModule?S(n,"default",{value:e,enumerable:!0}):n,e));var M=u(require("./node_modules/dotenv/lib/main.js"),1),O=u(require("./node_modules/next/dist/server/next.js"),1),j=u(require("./node_modules/express/index.js"),1),P=require("./node_modules/mongodb/lib/index.js"),$=require("./node_modules/bson/lib/bson.js"),E=u(require("./node_modules/formidable/src/index.js"),1),s=require("fs"),H=require("crypto");M.config({path:"/.env.local"});function W(e){let t=new TextEncoder().encode(e),n=(0,H.createHash)("sha256").update(t).digest();return Array.from(new Uint8Array(n)).map(l=>l.toString(16).padStart(2,"0")).join("")}var v=parseInt(`${process.env.PORT}`,10)||3e3,A=process.env.NODE_ENV!=="production",C=(0,O.default)({dev:A}),q=C.getRequestHandler(),G="mongodb+srv://expressjs:fVlgIRopIn2V6LLN@cluster0.n9ki8.mongodb.net/?retryWrites=true&w=majority",y=A?"devProcurement":"Procurement",F="FilesMetadata",D=new P.MongoClient(G).connect();async function I(){return await D}async function U(){(await D).close()}process.on("SIGINT",e=>{console.log("Closing signal: "+e),U()});function J(e){return"originalFilename"in e}function K(e){return"length"in e}async function Q(e){return await(await I()).db(y).collection(F).findOne({_id:e},{projection:{filename:1,dir:1}})}async function X(e){return await(await I()).db(y).collection(F).insertOne(e).then(n=>n.insertedId)}async function Y(e,t){return await(await I()).db(y).collection(F).updateOne({_id:e},{$set:{dir:t.dir}}).then(a=>a.upsertedId)}var w="./files/";C.prepare().then(()=>{let e=(0,j.default)();e.get("/files/:fmid",async(t,n,a)=>{try{let o=await Q(new $.ObjectId(t.params.fmid));if(o){let{filename:l,dir:r}=o;console.log(`File downloading: ${l}
At: ${r}`),n.download(`${r}`,`${l}`,function(d){return d?(console.log(`Error downloading: ${d}`),a(d)):(console.log(`Successfully downloaded: ${l}`),n.status(200).end())})}else return n.status(404).end("Can't find that file, sorry!")}catch(o){return console.log(o),n.status(500).end("Something went wrong.")}}).post("/files/",async(t,n,a)=>{let o=(0,E.default)(),l=new Promise((r,d)=>{o.parse(t,(c,f,i)=>{c&&d(c),r({fields:f,files:i})})});(0,s.existsSync)(w)||(0,s.mkdirSync)(w),await l.then(r=>{let{fields:d,files:c}=r,f=[];if(J(c.file)?f[0]=c.file:K(c.file)&&(f=c.file),f.length<1)throw new Error("Can't find any files");f.forEach(async i=>{let x=i.originalFilename?.lastIndexOf("."),b=i.originalFilename?.substring(x?x+1:0),m=await X({filename:i.originalFilename?i.originalFilename:"",filetype:b||"",contentType:i.mimetype?i.mimetype:"",size:i.size,uploadDate:new Date}),g=w+W(m.toHexString());return await new Promise((p,N)=>{let B=(0,s.createReadStream)(i.filepath),h=(0,s.createWriteStream)(g);h.on("error",R=>{N(R)}),h.on("finish",()=>{p()}),B.pipe(h)}).catch(p=>{throw new Error(p)}),await Y(m,{dir:g}),console.log(`New file uploaded at: ${g}`),console.log("fmid: "+m.toHexString()),n.status(201).json({data:{fmid:m.toHexString()}})})}).catch(r=>(console.log(r),n.status(500).end(r)))}).all("*",(t,n)=>q(t,n)),e.listen(v,()=>{console.log(`Server started on port ${v}`)})}).catch(e=>{console.error(e),process.exit(1)});
